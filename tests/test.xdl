namespace T;

error ERR1 = 1;
error ERR2 = 2;

struct Struct
{
    string      v_string;
}

struct AllArrays
{
    array<string>      a_string;
    array<time>        a_time;
    array<blob>        a_blob;
    array<int>         a_int;
    array<boolean>     a_boolean;
//    array<double>      a_double;
    array<any>         a_any;
    array<Struct>      a_struct;
    array<array<string>> aa_string;
    array<array<array<string>>> aaa_string;
}

struct AllTypes
{
    string      v_string;
    time        v_time;
    blob        v_blob;
    int         v_int;
    boolean     v_boolean;
    double      v_double;
    any         v_any;
    Struct      v_struct;
    AllArrays   v_arrays;
}

servlet Test1
{
  <%
#include <stdio.h>
#include <string.h>
  %>

  error NOTHING = 2;
  error NO_DATA = 5;

  AllTypes getAll()
  <%
    printf("getAll()\n");
    retval = TAllTypes_new();
    retval->v_string = g_strdup("Hi!");
    retval->v_time = g_strdup("2006-04-04");
    retval->v_blob = xr_blob_new(g_strdup("Hi all!"), strlen("Hi all!"));
    retval->v_int = 5645;
    retval->v_boolean = FALSE;
    retval->v_double = 123.123e-3;
    retval->v_any = xr_value_string_new("test");
    retval->v_struct = TStruct_new();
    retval->v_struct->v_string = g_strdup("some str");
    retval->v_arrays = TAllArrays_new();
  %>

  AllArrays getAllArrays()
  <%
    int i;

#define ADD(a, val) retval->a = g_slist_append(retval->a, val)

    printf("getAllArrays()\n");

    retval = TAllArrays_new();
    for (i = 0; i < 5; i++)
      ADD(a_string, g_strdup_printf("str%d", i));
    for (i = 1; i < 10; i++)
      ADD(a_time, g_strdup_printf("2006-04-%02d", i));
    for (i = 0; i < 2; i++)
      ADD(a_blob, xr_blob_new(g_strdup_printf("BBBBBBBBBBBBBBBBBLOOOOOB%d", i), -1));
    for (i = 0; i < 10; i++)
      ADD(a_int, (gpointer)i);
    for (i = 0; i < 10; i++)
      ADD(a_boolean, (gpointer)g_random_boolean());
//    for (i = 0; i < 5; i++)
//      ADD(a_double, (gpointer)(double)(i * 1.11e-3));
    for (i = 0; i < 10; i++)
      if (g_random_boolean())
      {
        char* val = g_strdup_printf("%d", i);
        ADD(a_any, xr_value_string_new(val));
        g_free(val);
      }
      else
        ADD(a_any, xr_value_int_new(i));
    for (i = 0; i < 2; i++)
    {
      TStruct* s = TStruct_new();
      s->v_string = g_strdup_printf("struct val %d", i);
      ADD(a_struct, s);
    }
    for (i = 0; i < 2; i++)
    {
      GSList* a = NULL;
      int j;

      for (j = 0; j < 10; j++)
        a = g_slist_append(a, g_strdup_printf("[%d %d]", i, j));

      ADD(aa_string, a);
    }
    for (i = 0; i < 2; i++)
    {
      GSList* a = NULL;
      int j;

      for (j = 0; j < 10; j++)
      {
        GSList* b = NULL;
        int k;

        for (k = 0; k < 3; k++)
          b = g_slist_append(b, g_strdup_printf("[%d %d %d]", i, j, k));

        a = g_slist_append(a, b);
      }

      ADD(aaa_string, a);
    }

#undef ADD

  %>
  
  boolean setAll(AllTypes all)
  <%
    printf("setAll()\n");
  %>

  array<string> getBigArray()
  <%
    int i;
    for (i=0; i<5000; i++)
      retval = g_slist_append(retval, g_strdup_printf("user.bob%d@zonio.net", i));
  %>

  boolean putBigArray(take array<string> arr)
  <%
    g_slist_foreach(arr, (GFunc)g_free, NULL);
    g_slist_free(arr);
  %>

  __attrs__
  <%
    char* username;
  %>
  
  __init__
  <%
    printf("Init!\n");
  %>

  __fini__
  <%
    printf("Fini!\n");
  %>

  __pre_call__
  <%
    //printf("Pre-call!\n");
  %>

  __post_call__
  <%
    //printf("Post-call!\n");
  %>
}

servlet Test2
{
  <%
#include <stdio.h>
#include <string.h>
  %>

  __attrs__
  <%
    char* username;
  %>
  
  __init__
  <%
    printf("Init!\n");
  %>

  __fini__
  <%
    printf("Fini!\n");
  %>

  boolean auth(string name)
  <%
    printf("auth(%s)!\n", name);
  %>
}
