/* 
 * Copyright 2006, 2007 Ondrej Jirman <ondrej.jirman@zonio.net>
 * 
 * This file is part of libxr.
 *
 * Libxr is free software: you can redistribute it and/or modify it under the
 * terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 *
 * Libxr is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with libxr.  If not, see <http://www.gnu.org/licenses/>.
 */

namespace T;

error ERR1 = 1;
error ERR2 = 2;

struct Struct
{
    string      v_string;
}

struct AllArrays
{
    array<string>      a_string;
    array<time>        a_time;
    array<blob>        a_blob;
    array<int>         a_int;
    array<boolean>     a_boolean;
//    array<double>      a_double;
    array<any>         a_any;
    array<Struct>      a_struct;
    array<array<string>> aa_string;
    array<array<array<string>>> aaa_string;
}

struct AllTypes
{
    string      v_string;
    time        v_time;
    blob        v_blob;
    int         v_int;
    boolean     v_boolean;
    double      v_double;
    any         v_any;
    Struct      v_struct;
    AllArrays   v_arrays;
}

servlet Test1
{
  <%
#include <stdio.h>
#include <string.h>
  %>

  error NOTHING = 2;
  error NO_DATA = 5;

  AllTypes getAll()
  <%
    printf("getAll()\n");
    retval = TAllTypes_new();
    retval->v_string = g_strdup("Hi!");
    retval->v_time = g_strdup("2006-04-04");
    retval->v_blob = xr_blob_new(g_strdup("Hi all!"), strlen("Hi all!"));
    retval->v_int = 5645;
    retval->v_boolean = FALSE;
    retval->v_double = 123.123e-3;
    retval->v_any = xr_value_string_new("test");
    retval->v_struct = TStruct_new();
    retval->v_struct->v_string = g_strdup("some str");
    retval->v_arrays = TAllArrays_new();
  %>

  AllArrays getAllArrays()
  <%
    int i;

#define ADD(a, val) retval->a = g_slist_append(retval->a, val)

    printf("getAllArrays()\n");

    retval = TAllArrays_new();
    for (i = 0; i < 5; i++)
      ADD(a_string, g_strdup_printf("str%d", i));
    for (i = 1; i < 10; i++)
      ADD(a_time, g_strdup_printf("2006-04-%02d", i));
    for (i = 0; i < 2; i++)
      ADD(a_blob, xr_blob_new(g_strdup_printf("BBBBBBBBBBBBBBBBBLOOOOOB%d", i), -1));
    for (i = 0; i < 10; i++)
      ADD(a_int, (gpointer)i);
    for (i = 0; i < 10; i++)
      ADD(a_boolean, (gpointer)g_random_boolean());
//    for (i = 0; i < 5; i++)
//      ADD(a_double, (gpointer)(double)(i * 1.11e-3));
    for (i = 0; i < 10; i++)
      if (g_random_boolean())
      {
        char* val = g_strdup_printf("%d", i);
        ADD(a_any, xr_value_string_new(val));
        g_free(val);
      }
      else
        ADD(a_any, xr_value_int_new(i));
    for (i = 0; i < 2; i++)
    {
      TStruct* s = TStruct_new();
      s->v_string = g_strdup_printf("struct val %d", i);
      ADD(a_struct, s);
    }
    for (i = 0; i < 2; i++)
    {
      GSList* a = NULL;
      int j;

      for (j = 0; j < 10; j++)
        a = g_slist_append(a, g_strdup_printf("[%d %d]", i, j));

      ADD(aa_string, a);
    }
    for (i = 0; i < 2; i++)
    {
      GSList* a = NULL;
      int j;

      for (j = 0; j < 10; j++)
      {
        GSList* b = NULL;
        int k;

        for (k = 0; k < 3; k++)
          b = g_slist_append(b, g_strdup_printf("[%d %d %d]", i, j, k));

        a = g_slist_append(a, b);
      }

      ADD(aaa_string, a);
    }

#undef ADD

  %>
  
  boolean setAll(AllTypes all)
  <%
    printf("setAll()\n");
  %>

  array<string> getBigArray()
  <%
    int i;
    for (i=0; i<5000; i++)
      retval = g_slist_append(retval, g_strdup_printf("user.bob%d@zonio.net", i));
  %>

  boolean putBigArray(take array<string> arr)
  <%
    g_slist_foreach(arr, (GFunc)g_free, NULL);
    g_slist_free(arr);
  %>

  __attrs__
  <%
    char* username;
  %>
  
  __init__
  <%
    printf("Init!\n");
  %>

  __fini__
  <%
    printf("Fini!\n");
  %>

  __pre_call__
  <%
    //printf("Pre-call!\n");
  %>

  __post_call__
  <%
    //printf("Post-call!\n");
  %>

  /* serve GET request, if serverd return TRUE, otherwise return FALSE */
  __download__
  <%
    const char* path = xr_http_get_resource(_http);
    //const char* username = xr_http_get_auth_username(_http);
    //const char* password = xr_http_get_auth_password(_http);

    if (!strcmp(path, "/test.file"))
    {
      //if (username && password && !strcmp(username, "bob") && !strcmp(password, "qwe"))
      if (1)
      {
        xr_http_setup_response(_http, 200);
        xr_http_set_header(_http, "Content-Type", "text/plain");
        xr_http_write_all(_http, "crap", 4, NULL);
        return TRUE;
      }
    }
    else if (!strcmp(path, "/test.file.2"))
    {
    }
    else
    {
      GString* response = g_string_sized_new(100);
      g_string_append_printf(response, "<html><head><title>401 Not Authorized</title></head><body><h1>401 Not Authorized</h1><p>You are not authorized to download %s</p></body></html>", path);

      xr_http_setup_response(_http, 401);
      xr_http_set_header(_http, "Content-Type", "text/html");
      xr_http_write_all(_http, response->str, response->len, NULL);

      g_string_free(response, TRUE);
      return TRUE;
    }
  %>

  __upload__
  <%
  %>
}

servlet Test2
{
  <%
#include <stdio.h>
#include <string.h>
  %>

  __attrs__
  <%
    char* username;
  %>
  
  __init__
  <%
    printf("Init!\n");
  %>

  __fini__
  <%
    printf("Fini!\n");
  %>

  boolean auth(string name)
  <%
    printf("auth(%s)!\n", name);
  %>
}
